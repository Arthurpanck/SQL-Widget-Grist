<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>S√©lection de bouton</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../shared/core/data-manager.js"></script>
    <script src="../shared/core/grist-connector.js"></script>
    <script src="../shared/core/button-manager.js"></script>
    <script src="../shared/ui/page-navigation.js"></script>
    <script src="../shared/ui/navigation.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .button-selector {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.9);
            opacity: 0.7;
            position: relative;
            overflow: hidden;
        }
        
        .button-selector:hover {
            transform: scale(0.95);
            opacity: 0.9;
        }
        
        .button-selector.selected {
            transform: scale(1.05);
            opacity: 1;
            z-index: 10;
        }
        
        .button-selector.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
        }
        
        .button-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .button-selector:hover::before {
            left: 100%;
        }
        
        .container-background {
            background: #f8f9fa;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-green': '#a8e6cf',
                        'soft-green-text': '#2e7d32',
                        'soft-orange': '#ffb366',
                        'soft-orange-text': '#5d4037',
                        'soft-pink': '#f8bbd9',
                        'soft-pink-text': '#6a1b9a',
                        'soft-blue': '#a8d8ea',
                        'soft-blue-text': '#1565c0',
                        'soft-purple': '#d1c4e9',
                        'soft-purple-text': '#4527a0',
                        'soft-yellow': '#fff3a0',
                        'soft-yellow-text': '#f57f17',
                        'soft-teal': '#b2dfdb',
                        'soft-teal-text': '#00695c',
                        'soft-coral': '#ffcdd2',
                        'soft-coral-text': '#c62828'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl relative">
        <!-- Navigation compacte en haut √† droite -->
        <div class="absolute top-4 right-4" id="compact-navigation">
        </div>
        
        <h1 class="text-2xl font-bold text-gray-800 mb-2 mr-24">S√©lectionnez le bouton √† afficher</h1>
        <p class="text-gray-500 mb-8">Choisissez le bouton qui sera visible par l'utilisateur. Un seul choix est possible.</p>
        
        <!-- Message de chargement -->
        <div id="loading-section" class="flex justify-center mb-8">
            <div class="container-background p-8 rounded-2xl shadow-md text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-600">Chargement des boutons disponibles...</p>
            </div>
        </div>

        <!-- Section des boutons (sera peupl√©e dynamiquement) -->
        <div id="buttons-section" class="flex justify-center mb-8 hidden">
            <div class="container-background p-5 rounded-2xl shadow-md">
                <div id="buttons-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Les boutons seront inject√©s ici par JavaScript -->
                </div>
            </div>
        </div>

        <!-- Message si aucun bouton trouv√© -->
        <div id="no-buttons-section" class="flex justify-center mb-8 hidden">
            <div class="container-background p-8 rounded-2xl shadow-md text-center">
                <span class="material-icons text-gray-400 text-4xl mb-4">info</span>
                <p class="text-gray-600">Aucun bouton personnalis√© trouv√©.</p>
                <p class="text-gray-500 text-sm mt-2">Cr√©ez des boutons depuis l'√©diteur de flux pour les voir ici.</p>
            </div>
        </div>
        
        <div id="controls-section" class="border-t pt-6 flex justify-end items-center hidden">
            <div class="mr-auto">
                <span class="text-gray-600">Bouton s√©lectionn√© : </span>
                <span class="font-semibold text-gray-800" id="selected-button-text">Aucun</span>
            </div>
            <button id="cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg mr-4 hover:bg-gray-300 transition-colors">Annuler</button>
            <button id="save-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center transition-colors" disabled>
                <span class="material-icons mr-2">save</span>
                Sauvegarder
            </button>
        </div>
    </div>
</div>

    <script>
        // ================================================================================
        // BUTTON SELECTION PAGE - S√©lection de boutons dynamique avec Grist
        // ================================================================================
        
        // Variables globales
        let allButtons = []; // Tous les boutons disponibles
        let selectedButton = null; // Bouton actuellement s√©lectionn√©
        // Note: allRecords est d√©j√† d√©clar√© dans data-manager.js
        
        // Couleurs pr√©d√©finies pour les boutons
        const buttonColors = [
            { bg: 'bg-soft-green', text: 'text-soft-green-text' },
            { bg: 'bg-soft-orange', text: 'text-soft-orange-text' },
            { bg: 'bg-soft-pink', text: 'text-soft-pink-text' },
            { bg: 'bg-soft-blue', text: 'text-soft-blue-text' },
            { bg: 'bg-soft-purple', text: 'text-soft-purple-text' },
            { bg: 'bg-soft-yellow', text: 'text-soft-yellow-text' },
            { bg: 'bg-soft-teal', text: 'text-soft-teal-text' },
            { bg: 'bg-soft-coral', text: 'text-soft-coral-text' }
        ];
        
        /**
         * Initialise la page de s√©lection des boutons
         */
        function initializeButtonSelection() {
            console.log('üöÄ === INITIALISATION BUTTON SELECTION PAGE ===');
            console.log('configureGristSettings disponible:', typeof configureGristSettings === 'function');
            console.log('ButtonManager disponible:', typeof ButtonManager !== 'undefined');
            console.log('allRecords initial:', allRecords);
            console.log('buttonConfigField initial:', buttonConfigField);
            
            // Initialiser la navigation compacte
            if (typeof addCompactNavigationToContainer === 'function') {
                addCompactNavigationToContainer('button-selection-page', 'compact-navigation');
            }
            
            // Configurer Grist
            if (typeof configureGristSettings === 'function') {
                console.log('üì° Configuration de Grist...');
                configureGristSettings();
            } else {
                console.error('‚ùå configureGristSettings non disponible');
            }
            
            // Configurer les event listeners
            setupEventListeners();
            
            console.log('üöÄ === FIN INITIALISATION ===');
        }
        
        /**
         * Configure les event listeners
         */
        function setupEventListeners() {
            const saveBtn = document.getElementById('save-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            if (saveBtn) {
                saveBtn.addEventListener('click', handleSaveButton);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', handleCancelButton);
            }
        }
        
        /**
         * Charge et affiche tous les boutons disponibles
         */
        function loadAvailableButtons() {
            console.log('üîç === DEBUG CHARGEMENT BOUTONS ===');
            console.log('allRecords:', allRecords);
            console.log('allRecords.length:', allRecords ? allRecords.length : 'undefined');
            console.log('buttonConfigField:', buttonConfigField);
            console.log('ButtonManager disponible:', typeof ButtonManager !== 'undefined');
            
            if (!allRecords || allRecords.length === 0) {
                console.log('‚ùå Aucun enregistrement disponible');
                showNoButtons();
                return;
            }
            
            // Collecter tous les boutons uniques de tous les enregistrements
            const uniqueButtons = new Map(); // name -> button object
            let totalButtonsFound = 0;
            
            allRecords.forEach((record, recordIndex) => {
                console.log(`üìã Traitement enregistrement ${recordIndex + 1}/${allRecords.length} (ID: ${record.id})`);
                console.log('  buttonConfigField:', buttonConfigField);
                console.log('  record[buttonConfigField]:', record[buttonConfigField]);
                
                if (!buttonConfigField) {
                    console.log('  ‚ö†Ô∏è buttonConfigField non d√©fini');
                    return;
                }
                
                if (!record[buttonConfigField]) {
                    console.log('  ‚ö†Ô∏è Pas de donn√©es buttonconfig dans cet enregistrement');
                    return;
                }
                
                try {
                    console.log('  üîÑ Lecture des boutons avec ButtonManager...');
                    const buttons = ButtonManager.readButtonConfig(record);
                    console.log('  üì¶ Boutons trouv√©s:', buttons);
                    
                    buttons.forEach((button, buttonIndex) => {
                        console.log(`    üîò Bouton ${buttonIndex + 1}: "${button.name}" avec ${button.sequence ? button.sequence.length : 0} requ√™tes`);
                        
                        if (button.name && !uniqueButtons.has(button.name)) {
                            uniqueButtons.set(button.name, button);
                            totalButtonsFound++;
                            console.log(`    ‚úÖ Bouton unique ajout√©: "${button.name}"`);
                        } else if (button.name) {
                            console.log(`    ‚ö†Ô∏è Bouton d√©j√† existant ignor√©: "${button.name}"`);
                        } else {
                            console.log(`    ‚ùå Bouton sans nom ignor√©:`, button);
                        }
                    });
                } catch (error) {
                    console.error(`  ‚ùå Erreur lecture boutons pour enregistrement ${record.id}:`, error);
                }
            });
            
            allButtons = Array.from(uniqueButtons.values());
            console.log(`üéØ R√âSULTAT FINAL: ${allButtons.length} boutons uniques trouv√©s`);
            console.log('üìù Liste des boutons:', allButtons.map(b => b.name));
            console.log('üîç === FIN DEBUG CHARGEMENT ===');
            
            if (allButtons.length === 0) {
                console.log('üì≠ Aucun bouton trouv√© ‚Üí Affichage message "pas de boutons"');
                showNoButtons();
            } else {
                console.log('üé® Affichage des boutons');
                displayButtons();
            }
        }
        
        /**
         * Affiche les boutons dans la grille
         */
        function displayButtons() {
            const loadingSection = document.getElementById('loading-section');
            const buttonsSection = document.getElementById('buttons-section');
            const buttonsGrid = document.getElementById('buttons-grid');
            const controlsSection = document.getElementById('controls-section');
            
            // Masquer le loading, afficher la section boutons
            loadingSection.classList.add('hidden');
            buttonsSection.classList.remove('hidden');
            controlsSection.classList.remove('hidden');
            
            // Vider la grille
            buttonsGrid.innerHTML = '';
            
            // Cr√©er les boutons
            allButtons.forEach((button, index) => {
                const buttonElement = createButtonElement(button, index);
                buttonsGrid.appendChild(buttonElement);
            });
            
            // Configurer les event listeners pour la s√©lection
            setupButtonSelectionListeners();
        }
        
        /**
         * Cr√©e un √©l√©ment bouton pour la grille
         */
        function createButtonElement(button, index) {
            const colorScheme = buttonColors[index % buttonColors.length];
            const buttonId = `button-${index}`;
            
            const container = document.createElement('div');
            container.innerHTML = `
                <input class="hidden" id="${buttonId}" name="boutonSelection" type="radio" value="${button.name}"/>
                <label class="button-selector cursor-pointer flex items-center justify-center p-4 rounded-xl ${colorScheme.text} font-medium ${colorScheme.bg} shadow-md min-w-[120px] text-center" for="${buttonId}">
                    ${button.name}
                </label>
            `;
            
            return container;
        }
        
        /**
         * Configure les event listeners pour la s√©lection des boutons
         */
        function setupButtonSelectionListeners() {
            const radios = document.querySelectorAll('input[name="boutonSelection"]');
            const selectedButtonText = document.getElementById('selected-button-text');
            const saveBtn = document.getElementById('save-btn');
            
            radios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    // Retirer la classe selected de tous les labels
                    document.querySelectorAll('.button-selector').forEach(label => {
                        label.classList.remove('selected');
                    });
                    
                    // Ajouter la classe selected au label correspondant
                    const selectedLabel = document.querySelector(`label[for="${event.target.id}"]`);
                    selectedLabel.classList.add('selected');
                    
                    // Mettre √† jour le texte et l'√©tat
                    const buttonName = event.target.value;
                    selectedButtonText.textContent = buttonName;
                    selectedButton = allButtons.find(b => b.name === buttonName);
                    
                    // Activer le bouton Sauvegarder
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-50');
                    
                    console.log('Bouton s√©lectionn√©:', selectedButton);
                });
            });
        }
        
        /**
         * Affiche le message "aucun bouton"
         */
        function showNoButtons() {
            const loadingSection = document.getElementById('loading-section');
            const noButtonsSection = document.getElementById('no-buttons-section');
            
            loadingSection.classList.add('hidden');
            noButtonsSection.classList.remove('hidden');
        }
        
        /**
         * G√®re le clic sur le bouton Sauvegarder
         */
        function handleSaveButton() {
            if (!selectedButton) {
                alert('Veuillez s√©lectionner un bouton');
                return;
            }
            
            console.log('Sauvegarde et navigation vers view-user-page avec bouton:', selectedButton);
            
            // Sauvegarder la s√©lection dans localStorage pour la page suivante
            localStorage.setItem('selectedButton', JSON.stringify(selectedButton));
            
            // Naviguer vers view-user-page
            window.location.href = '../view-user-page/index.html';
        }
        
        /**
         * G√®re le clic sur le bouton Annuler
         */
        function handleCancelButton() {
            // Naviguer vers la page pr√©c√©dente ou une page par d√©faut
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '../button-flow-editor/index.html';
            }
        }
        
        /**
         * Override de onRecords pour recevoir tous les enregistrements
         */
        function onRecords(records, mappings) {
            console.log('üîÑ === DEBUG onRecords APPEL√â ===');
            console.log('Records re√ßus:', records);
            console.log('Mappings re√ßus:', mappings);
            console.log('Ancien allRecords:', allRecords);
            
            allRecords = records || [];
            console.log(`üìä ${allRecords.length} enregistrements re√ßus pour la s√©lection de boutons`);
            console.log('üîÑ === FIN DEBUG onRecords ===');
            
            // Charger les boutons disponibles
            loadAvailableButtons();
        }
        
        // Remplacer la fonction onRecords globale
        window.onRecords = onRecords;
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            initializeButtonSelection();
        });
    </script>
</body>
</html>